name: Go Security and Build Pipeline

on:
  push:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Run Tests
        run: go test -v ./...
      - name: Run Security Scan (SAST)
        uses: securego/gosec@master
        with:
          args: ./...

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Despliegue y Compilación Nativa
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_NAME }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/grup1/Proyecto
            ts=$(date +%s)

            # 1. Actualizar código fuente
            git pull origin main

            # 2. Backup del binario anterior (si existe)
            [ -f server_exe ] && cp server_exe server_exe.bak.$ts

            # 3. COMPILACIÓN NATIVA (En el propio servidor)
            # Esto soluciona los errores de "Syntax error" y "ELF not found"
            go build -o server_exe_new main.go
            
            # 4. Swap y Permisos
            mv server_exe_new server_exe
            chmod +x server_exe

            # 5. Reinicio
            fuser -k 8080/tcp || true
           
            nohup ./server_exe > output.log 2>&1 &

            # 6. Health Check
            echo "Esperando arranque..."
            sleep 10
            if curl -f http://127.0.0.1:8080/health; then
              echo "¡Despliegue exitoso!"
            else
              echo "--- ERROR: MOSTRANDO LOGS ---"
              cat output.log
              [ -f server_exe.bak.$ts ] && mv server_exe.bak.$ts server_exe && fuser -k 8080/tcp || true && nohup ./server_exe > output.log 2>&1 &
              exit 1
            fi